// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User accounts for authentication
model User {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sessions Session[]
  wallets  Wallet[]
}

// Database-backed sessions for long-lived auth
model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// Key-value settings storage
// Keys: setupComplete, setupStep, appName, appTimezone,
//       alchemyApiKey (encrypted), heliusApiKey (encrypted),
//       refreshesPerDay, tokenThresholdUsd
model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Blockchain wallet addresses for tracking crypto assets
model Wallet {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String?
  network   String   // "bitcoin", "ethereum", "arbitrum", "base", "polygon", "solana"
  address   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  snapshots BalanceSnapshot[]

  @@unique([userId, address])
  @@index([userId])
  @@index([network])
}

// Snapshot of wallet balance at a point in time
// Only created if ALL fetches for this wallet succeed
model BalanceSnapshot {
  id        String   @id @default(cuid())
  walletId  String
  wallet    Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  timestamp DateTime @default(now())

  // Native balance (ETH, BTC, SOL, etc.)
  nativeBalance    String  // Raw amount in smallest unit (wei, sats, lamports)
  nativeBalanceUsd Decimal // USD value at snapshot time
  nativePriceUsd   Decimal // Price used for calculation

  // Aggregates
  tokensUsdValue Decimal // Sum of all token values
  totalUsdValue  Decimal // native + tokens

  tokenSnapshots TokenSnapshot[]

  @@index([walletId])
  @@index([walletId, timestamp])
  @@index([timestamp])
}

// Individual token balance within a snapshot
model TokenSnapshot {
  id         String          @id @default(cuid())
  snapshotId String
  snapshot   BalanceSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  contractAddress String
  symbol          String
  name            String?
  decimals        Int
  logoUrl         String?
  balance         String  // Raw amount in smallest unit
  balanceUsd      Decimal
  priceUsd        Decimal // Price at snapshot time (for historical accuracy)

  @@index([snapshotId])
}

// Log of refresh attempts (scheduled or manual)
model RefreshLog {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  trigger   String   // "scheduled", "manual"
  status    String   // "success", "partial_failure", "complete_failure"

  walletsAttempted Int
  walletsSucceeded Int
  walletsFailed    Int

  durationMs Int?

  errors RefreshError[]

  @@index([timestamp])
}

// Individual errors during a refresh
model RefreshError {
  id           String     @id @default(cuid())
  refreshLogId String
  refreshLog   RefreshLog @relation(fields: [refreshLogId], references: [id], onDelete: Cascade)

  walletId      String?
  walletAddress String?
  network       String
  errorType     String  // "api_error", "timeout", "rate_limit", "parse_error", "price_error"
  errorMessage  String
  errorDetails  String? // JSON with full error context

  @@index([refreshLogId])
}

// Rate limiting for manual refresh
model RateLimit {
  id         String   @id @default(cuid())
  key        String   @unique // e.g., "refresh:manual"
  lastAction DateTime
  
  @@index([key])
}
